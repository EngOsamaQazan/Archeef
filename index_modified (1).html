<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ูุธุงู ุงุณุชูุงู ูุชุณููู ุงููุซุงุฆู</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>๐ ูุธุงู ุงุณุชูุงู ูุชุณููู ุงููุซุงุฆู</h1>
        <p>ุฅุฏุงุฑุฉ ุญุฑูุฉ ุงูุนููุฏ ุจูู ุงูููุชุจ ูุงูุฃุฑุดูู</p>
      </header>

      <div class="tabs">
        <button class="tab active" onclick="showTab('transaction')">
          ๐ ุชุณุฌูู ุญุฑูุฉ ุฌุฏูุฏุฉ
        </button>
        <button class="tab" onclick="showTab('search')">
          ๐ ุงูุจุญุซ ูุงูุงุณุชุนูุงู
        </button>
        <button class="tab" onclick="showTab('reports')">๐ ุงูุชูุงุฑูุฑ</button>
        <button class="tab" onclick="showTab('history')">๐ ุงูุณุฌู</button>
      </div>

      <div class="content">
        <!-- ูุงูุฐุฉ ุงูุฅุดุนุงุฑุงุช -->
        <div id="alert" class="alert"></div>

        <!-- ุชุจููุจ ุชุณุฌูู ุญุฑูุฉ ุฌุฏูุฏุฉ -->
        <div id="transaction" class="tab-content active">
          <div class="form-section">
            <h2>ุชุณุฌูู ุญุฑูุฉ ุงุณุชูุงู/ุชุณููู</h2>

            <div class="form-group">
              <label>ููุน ุงูุนูููุฉ:</label>
              <select id="transactionType" onchange="updateEmployeeSelects()">
                <option value="">-- ุงุฎุชุฑ ููุน ุงูุนูููุฉ --</option>
                <option value="ุชุณููู ูุงุณุชูุงู">ุชุณููู ูุงุณุชูุงู</option>
              </select>
            </div>

            <div class="form-group">
              <label>ุงูููุธู ุงูููุณูููู:</label>
              <select id="fromEmployee">
                <option value="">-- ุงุฎุชุฑ ุงูููุธู --</option>
              </select>
            </div>

            <div class="form-group">
              <label>ุงูููุธู ุงูููุณุชููู:</label>
              <select id="toEmployee">
                <option value="">-- ุงุฎุชุฑ ุงูููุธู --</option>
              </select>
            </div>

            <div class="form-group">
              <label>ูุฆุฉ ุงููุณุชูุฏ:</label>
              <select
                id="operationCategory"
                onchange="onOperationCategoryChange()"
              >
                <option value="ุนููุฏ" selected>ุนููุฏ</option>
                <option value="ูุชุจ ููุฑุงุณูุงุช">ูุชุจ ููุฑุงุณูุงุช</option>
                <option value="ูุชุจ ุญุณู">ูุชุจ ุญุณู</option>
              </select>
            </div>

            <div class="form-group">
              <label>ุทุฑููุฉ ุงูุชุณููู/ุงูุงุณุชูุงู:</label>
              <select id="deliveryMethod" onchange="onDeliveryMethodChange()">
                <option value="ุจุงููุฏ" selected>ุจุงููุฏ</option>
                <option value="ุจุฑูุฏ ุฃุฑุฏูู">ุจุฑูุฏ ุฃุฑุฏูู</option>
                <option value="Aramex">Aramex</option>
                <option value="DHL">DHL</option>
              </select>
            </div>

            <div class="form-group" id="trackingGroup" style="display: none">
              <label>ุฑูู ุงูุจูููุตุฉ:</label>
              <input
                id="trackingNumber"
                type="text"
                placeholder="ุฃุฏุฎู ุฑูู ุงูุชุชุจุน (ูุทููุจ ุนูุฏ ุดุฑูุงุช ุงูุดุญู)"
              />
            </div>

            <div class="form-group">
              <label>ูุตู ุงููุญุชููุงุช (ุงุฎุชูุงุฑู):</label>
              <textarea
                id="contents"
                rows="2"
                placeholder="ูุซุงู: 3 ุนููุฏ + ูุชุงุจ ูุฑุงุณูุฉ"
              ></textarea>
            </div>

            <!-- ุญููู ุฎุงุตุฉ ุจููุน 'ูุชุจ ุญุณู' -->
            <div
              id="sdlFields"
              style="
                display: none;
                background: #fff;
                border-radius: 10px;
                padding: 12px;
                border: 1px dashed #ccc;
                margin-bottom: 10px;
              "
            >
              <h3 style="margin-bottom: 10px">ุชูุงุตูู ูุชุงุจ ุงูุญุณู</h3>
              <div class="form-group">
                <label>ุงุณู ุงูุนููู:</label>
                <input
                  id="sdlCustomerName"
                  type="text"
                  placeholder="ุงุณู ุงูุนููู ุงููุฑุชุจุท ุจูุชุงุจ ุงูุญุณู"
                />
              </div>
              <div class="form-group">
                <label>ุฑูู ุงูุนูุฏ:</label>
                <input
                  id="sdlContractNumber"
                  type="text"
                  placeholder="ุฑูู ุงูุนูุฏ ููุฐุง ุงููุชุงุจ"
                />
              </div>
              <div class="form-group">
                <label>ุฑูู ุงููุถูุฉ:</label>
                <input
                  id="sdlJudiciaryNumber"
                  type="text"
                  placeholder="ุฑูู ุงููุถูุฉ"
                />
              </div>
              <div class="form-group">
                <label>ุณูุฉ ุงููุถูุฉ:</label>
                <input
                  id="sdlJudiciaryYear"
                  type="number"
                  min="1900"
                  max="2100"
                  placeholder="YYYY"
                />
              </div>
              <p style="color: #666; font-size: 0.9em">
                ููุงุญุธุฉ: ูุชุงุจ ุงูุญุณู ูุฑุชุจุท ุจุนููู ูุงุญุฏ ูุนูุฏ ูุงุญุฏ ููุถูุฉ ูุงุญุฏุฉ
                (ุฑูู/ุณูุฉ).
              </p>
            </div>

            <div class="form-group">
              <label>ุฃุฑูุงู ุงูุนููุฏ (ูู ุฑูู ูู ุณุทุฑ ูููุตู):</label>
              <textarea
                id="contractNumbers"
                class="contracts-input"
                placeholder="ุฃุฏุฎู ุฃุฑูุงู ุงูุนููุฏุ ูู ุฑูู ูู ุณุทุฑ ูููุตู&#10;ูุซุงู:&#10;12345&#10;67890&#10;11223"
              ></textarea>
            </div>

            <div class="form-group">
              <label>ููุงุญุธุงุช (ุงุฎุชูุงุฑู):</label>
              <textarea
                id="notes"
                rows="3"
                placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..."
              ></textarea>
            </div>

            <button class="btn" onclick="submitTransaction()">
              ๐พ ุญูุธ ูุทุจุงุนุฉ ุงูุฅูุตุงู
            </button>
          </div>
        </div>

        <!-- ุชุจููุจ ุงูุจุญุซ -->
        <div id="search" class="tab-content">
          <div class="form-section">
            <h2>ุงูุจุญุซ ุนู ุนูุฏ</h2>

            <div class="search-box">
              <input
                type="text"
                id="searchInput"
                placeholder="ุฃุฏุฎู ุฑูู ุงูุนูุฏ ููุจุญุซ..."
                onkeyup="searchContract(event)"
              />
            </div>

            <button class="btn btn-secondary" onclick="performSearch()">
              ๐ ุจุญุซ
            </button>

            <div id="searchResults" class="results" style="display: none">
              <!-- ูุชุงุฆุฌ ุงูุจุญุซ ุณุชุธูุฑ ููุง -->
            </div>
          </div>

          <div class="form-section">
            <h2>ุนุฑุถ ุฌููุน ุงูุนููุฏ</h2>
            <button class="btn btn-success" onclick="showAllContracts()">
              ๐ ุนุฑุถ ุฌููุน ุงูุนููุฏ
            </button>

            <div id="allContracts" class="results" style="display: none">
              <!-- ุฌููุน ุงูุนููุฏ ุณุชุธูุฑ ููุง -->
            </div>
          </div>
        </div>

        <!-- ุชุจููุจ ุงูุชูุงุฑูุฑ -->
        <div id="reports" class="tab-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalContracts">0</div>
              <div class="stat-label">ุฅุฌูุงูู ุงูุนููุฏ</div>
            </div>
            <div
              class="stat-card"
              style="
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
              "
            >
              <div class="stat-number" id="totalTransactions">0</div>
              <div class="stat-label">ุฅุฌูุงูู ุงูุญุฑูุงุช</div>
            </div>
            <div
              class="stat-card"
              style="
                background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
              "
            >
              <div class="stat-number" id="todayTransactions">0</div>
              <div class="stat-label">ุญุฑูุงุช ุงูููู</div>
            </div>
          </div>

          <div class="form-section">
            <h2>ุชูุงุฑูุฑ ุงูุญุฑูุงุช</h2>

            <div class="form-group">
              <label>ุงููุชุฑุฉ ุงูุฒูููุฉ:</label>
              <select id="reportPeriod" onchange="generateReport()">
                <option value="today">ุงูููู</option>
                <option value="week">ูุฐุง ุงูุฃุณุจูุน</option>
                <option value="month">ูุฐุง ุงูุดูุฑ</option>
                <option value="all">ุงููู</option>
              </select>
            </div>

            <div id="reportContent" class="results">
              <!-- ูุญุชูู ุงูุชูุฑูุฑ ุณูุธูุฑ ููุง -->
            </div>
          </div>
        </div>

        <!-- ุชุจููุจ ุงูุณุฌู -->
        <div id="history" class="tab-content">
          <div class="form-section">
            <h2>ุณุฌู ุงูุญุฑูุงุช</h2>

            <div class="form-group">
              <label>ุนุฑุถ ุญุฑูุงุช:</label>
              <select id="historyFilter" onchange="loadHistory()">
                <option value="all">ุฌููุน ุงูุญุฑูุงุช</option>
                <option value="ุงุณุชูุงู">ุงูุงุณุชูุงู ููุท</option>
                <option value="ุชุณููู">ุงูุชุณููู ููุท</option>
              </select>
            </div>

            <div id="historyContent">
              <table id="historyTable">
                <thead>
                  <tr>
                    <th>ุฑูู ุงูุฅูุตุงู</th>
                    <th>ุงูุชุงุฑูุฎ</th>
                    <th>ุงูููุน</th>
                    <th>ูู</th>
                    <th>ุฅูู</th>
                    <th>ุนุฏุฏ ุงูุนููุฏ</th>
                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody">
                  <!-- ุณุฌู ุงูุญุฑูุงุช ุณูุธูุฑ ููุง -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ูุคุดุฑ ุงูุชุญููู -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>ุฌุงุฑู ุงููุนุงูุฌุฉ...</p>
        </div>
      </div>
    </div>

    <!-- ูุงูุฐุฉ ุงูุฅูุตุงู -->
    <div id="receiptModal" class="modal">
      <div class="modal-content">
        <div id="receiptContent">
          <!-- ูุญุชูู ุงูุฅูุตุงู ุณูุธูุฑ ููุง -->
        </div>
        <div class="no-print" style="text-align: center; margin-top: 20px">
          <button class="btn" onclick="printReceipt()">๐จ๏ธ ุทุจุงุนุฉ</button>
          <button class="btn btn-secondary" onclick="closeModal()">
            ุฅุบูุงู
          </button>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script>
            // ุฅุนุฏุงุฏุงุช Supabase
            const SUPABASE_URL = window.APP_CONFIG?.SUPABASE_URL || "";
            const SUPABASE_ANON_KEY = window.APP_CONFIG?.SUPABASE_ANON_KEY || "";

            // ุชููุฆุฉ Supabase Client
            let supabase;

      // ========== Helpers for new fields ==========
            const shippingMethods = ['ุจุฑูุฏ ุฃุฑุฏูู','Aramex','DHL'];

            function onDeliveryMethodChange() {
              const method = document.getElementById('deliveryMethod').value;
              const trackingGroup = document.getElementById('trackingGroup');
              trackingGroup.style.display = shippingMethods.includes(method) ? 'block' : 'none';
            }

            function onOperationCategoryChange() {
              const cat = document.getElementById('operationCategory').value;
              const sdl = document.getElementById('sdlFields');
              const contractsArea = document.getElementById('contractNumbers').closest('.form-group');
              if (cat === 'ูุชุจ ุญุณู') {
                sdl.style.display = 'block';
                contractsArea.style.display = 'none'; // ูุชุงุจ ุงูุญุณู ุนูุฏ ูุงุญุฏ ููุท ุนุจุฑ ุงูุญูู ุงููุฎุตุต
              } else {
                sdl.style.display = 'none';
                contractsArea.style.display = 'block';
              }
            }

            // ุฏุงูุฉ ุชูุณูู ุงูุชุงุฑูุฎ ูุงูููุช ูุน AM/PM
            function formatDate(dateString) {
              const date = new Date(dateString);
              const day = date.getDate().toString().padStart(2, "0");
              const month = (date.getMonth() + 1).toString().padStart(2, "0");
              const year = date.getFullYear();

              let hours = date.getHours();
              const minutes = date.getMinutes().toString().padStart(2, "0");
              const ampm = hours >= 12 ? "PM" : "AM";

              // ุชุญููู ูู 24 ุณุงุนุฉ ุฅูู 12 ุณุงุนุฉ
              hours = hours % 12;
              hours = hours ? hours : 12; // ุงูุณุงุนุฉ 0 ุชุตุจุญ 12
              hours = hours.toString().padStart(2, "0");

              return `${day}/${month}/${year} - ${hours}:${minutes} ${ampm}`;
            }
            // ุชุญููู ููุชุจุฉ Supabase
            const script = document.createElement("script");
            script.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
            script.onload = function () {
              supabase = window.supabase.createClient(
                SUPABASE_URL,
                SUPABASE_ANON_KEY
              );
              initializeApp(); onOperationCategoryChange(); onDeliveryMethodChange();
            };
            document.head.appendChild(script);

            // ุจูุงูุงุช ุงูููุธููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุชุฌููุน ุญุณุจ ุงููุณู)
            let employeesByDept = {};

            // ุชููุฆุฉ ุงูุชุทุจูู
            async function initializeApp() {
              await loadEmployees();
              await loadStatistics();
              await loadHistory();
            }

            // ุชุญููู ุงูููุธููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            async function loadEmployees() {
              try {
                const { data, error } = await supabase
                  .from("employees")
                  .select("*")
                  .order("name");

                if (error) throw error;

                // ุจูุงุก employeesByDept ุฏููุงููููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                employeesByDept = {};
                if (Array.isArray(data)) {
                  data.forEach((row) => {
                    const dept = row.department || "ุบูุฑ ูุญุฏุฏ";
                    const name = row.name;
                    if (!employeesByDept[dept]) employeesByDept[dept] = [];
                    if (name) employeesByDept[dept].push(name);
                  });
                  // ุชุฑุชูุจ ุงูุฃุณูุงุก ุฏุงุฎู ูู ูุณู ููุงุณุชุฎุฏุงู ุงููุฑุชูุจ ูู ุงูููุงุฆู
                  Object.keys(employeesByDept).forEach((dept) => {
                    employeesByDept[dept].sort((a, b) => a.localeCompare(b, "ar"));
                  });
                }

                // ุชุญุฏูุซ ููุงุฆู ุงูููุธููู
                updateEmployeeSelects();
              } catch (error) {
                console.error("ุฎุทุฃ ูู ุชุญููู ุงูููุธููู:", error);
              }
            }

            // ุชุจุฏูู ุงูุชุจููุจุงุช
            function showTab(tabName) {
              // ุฅุฎูุงุก ุฌููุน ุงูุชุจููุจุงุช
              document.querySelectorAll(".tab-content").forEach((content) => {
                content.classList.remove("active");
              });

              // ุฅุฒุงูุฉ ุงูุชูุนูู ูู ุฌููุน ุงูุฃุฒุฑุงุฑ
              document.querySelectorAll(".tab").forEach((tab) => {
                tab.classList.remove("active");
              });

              // ุนุฑุถ ุงูุชุจููุจ ุงููุญุฏุฏ
              document.getElementById(tabName).classList.add("active");

              // ุชูุนูู ุงูุฒุฑ ุงููุญุฏุฏ
              event.target.classList.add("active");

              // ุชุญููู ุงูุจูุงูุงุช ุญุณุจ ุงูุชุจููุจ
              if (tabName === "reports") {
                loadStatistics();
                generateReport();
              } else if (tabName === "history") {
                loadHistory();
              }
            }

            // ุชุญุฏูุซ ููุงุฆู ุงูููุธููู - ุงูุณูุงุญ ุจุงูุชุณููู ูุงูุงุณุชูุงู ุจูู ุงูุฌููุน
            function updateEmployeeSelects() {
              const transactionType =
                document.getElementById("transactionType").value;
              const fromSelect = document.getElementById("fromEmployee");
              const toSelect = document.getElementById("toEmployee");

              // ูุณุญ ุงูููุงุฆู ุงูุญุงููุฉ
              fromSelect.innerHTML =
                '<option value="">-- ุงุฎุชุฑ ุงูููุธู ุงูููุณูููู --</option>';
              toSelect.innerHTML =
                '<option value="">-- ุงุฎุชุฑ ุงูููุธู ุงูููุณุชููู --</option>';

              if (transactionType === "ุชุณููู ูุงุณุชูุงู") {
                // ุฅุถุงูุฉ ุฌููุน ุงูููุธููู ูุน ุฃูุณุงููู ูููุถูุญ

                // ูุงุฆูุฉ ุงูููุณูููู
                fromSelect.innerHTML += '<optgroup label="ูุณู ุงูููุชุจ">';
                (employeesByDept["ููุชุจ"] || []).forEach((emp) => {
                  fromSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                });
                fromSelect.innerHTML += "</optgroup>";

                fromSelect.innerHTML += '<optgroup label="ูุณู ุงูุฃุฑุดูู">';
                (employeesByDept["ุฃุฑุดูู"] || []).forEach((emp) => {
                  fromSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                });
                fromSelect.innerHTML += "</optgroup>";

                fromSelect.innerHTML += '<optgroup label="ูุณู ุงููุจูุนุงุช">';
                (employeesByDept["ูุจูุนุงุช"] || []).forEach((emp) => {
                  fromSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                });
                fromSelect.innerHTML += "</optgroup>";

                // ูุงุฆูุฉ ุงูููุณุชููู
                toSelect.innerHTML += '<optgroup label="ูุณู ุงูููุชุจ">';
                (employeesByDept["ููุชุจ"] || []).forEach((emp) => {
                  toSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                });
                toSelect.innerHTML += "</optgroup>";

                toSelect.innerHTML += '<optgroup label="ูุณู ุงูุฃุฑุดูู">';
                (employeesByDept["ุฃุฑุดูู"] || []).forEach((emp) => {
                  toSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                });
                toSelect.innerHTML += "</optgroup>";

                toSelect.innerHTML += '<optgroup label="ูุณู ุงููุจูุนุงุช">';
                (employeesByDept["ูุจูุนุงุช"] || []).forEach((emp) => {
                  toSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                });
                toSelect.innerHTML += "</optgroup>";
              }
            }

            // ุฏุงูุฉ ููุญุตูู ุนูู ูุณู ุงูููุธู (ูู ุงูุจูุงูุงุช ุงููุญูููุฉ)
            function getEmployeeDepartment(employeeName) {
              for (const [dept, empList] of Object.entries(employeesByDept)) {
                if (empList.includes(employeeName)) {
                  return dept;
                }
              }
              return null;
            }

            // ุฅุฑุณุงู ุงูุญุฑูุฉ

            async function submitTransaction() {
              const transactionType = document.getElementById("transactionType").value;
              const fromEmployee = document.getElementById("fromEmployee").value;
              const toEmployee = document.getElementById("toEmployee").value;

              const operationCategory = document.getElementById("operationCategory").value;
              const deliveryMethod = document.getElementById("deliveryMethod").value;
              const trackingNumber = document.getElementById("trackingNumber").value.trim() || null;
              const contents = document.getElementById("contents").value.trim() || null;

              // ูุชุงุจ ุงูุญุณู (SDL) specific
              const sdlCustomerName = document.getElementById("sdlCustomerName")?.value.trim() || null;
              const sdlContractNumber = document.getElementById("sdlContractNumber")?.value.trim() || null;
              const sdlJudiciaryNumber = document.getElementById("sdlJudiciaryNumber")?.value.trim() || null;
              const sdlJudiciaryYear = document.getElementById("sdlJudiciaryYear")?.value || null;

              // ุงูุนููุฏ (ูุชุนุฏุฏุฉ ุงูุฃุณุทุฑ ููุญุงูุงุช ุงูุฃุฎุฑู)
              let contractNumbers = document.getElementById("contractNumbers").value
                  .split("\\n").filter((num) => num.trim() !== "");

              const notes = document.getElementById("notes").value;

              // ===== Validation =====
              if (!transactionType || !fromEmployee || !toEmployee) {
                showAlert("ูุฑุฌู ุงุฎุชูุงุฑ ููุน ุงูุนูููุฉ ูุงูููุธููู", "error"); return;
              }
              if (operationCategory === 'ูุชุจ ุญุณู') {
                if (!sdlCustomerName || !sdlContractNumber || !sdlJudiciaryNumber || !sdlJudiciaryYear) {
                  showAlert("ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุญููู ูุชุงุจ ุงูุญุณู (ุงุณู ุงูุนูููุ ุฑูู ุงูุนูุฏุ ุฑูู ุงููุถูุฉุ ุงูุณูุฉ)", "error"); return;
                }
                // ูุชุงุจ ุงูุญุณู: ุนูุฏ ูุงุญุฏ ููุท
                contractNumbers = [sdlContractNumber];
              } else {
                if (contractNumbers.length === 0) {
                  showAlert("ูุฑุฌู ุฅุฏุฎุงู ุฑูู/ุฃุฑูุงู ุงูุนููุฏ", "error"); return;
                }
              }
              if (shippingMethods.includes(deliveryMethod) && !trackingNumber) {
                showAlert("ูุฌุจ ุฅุฏุฎุงู ุฑูู ุงูุจูููุตุฉ ุนูุฏ ุงุฎุชูุงุฑ ุดุฑูุฉ ุดุญู", "error"); return;
              }

              showLoading(true);

              try {
                // ุฌูุจ ุจูุงูุงุช ุงูููุธููู
                const { data: fromEmp } = await supabase.from("employees").select("id, name").eq("name", fromEmployee).single();
                const { data: toEmp }   = await supabase.from("employees").select("id, name").eq("name", toEmployee).single();
                if (!fromEmp || !toEmp) throw new Error("ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ุงูููุธููู");

                // ุชูููุฏ ุฑูู ุฅูุตุงู
                const receiptNumber = "RCPT-" + Date.now();

                // ุชุญุฏูุฏ ููุน ุงููุนู ุงููุนูู ุญุณุจ ุงูุฃูุณุงู (ููุง ูุงู ุณุงุจูุงู)
                const fromDept = getEmployeeDepartment(fromEmployee);
                const toDept   = getEmployeeDepartment(toEmployee);
                let actualTransactionType = transactionType;
                if (fromDept === "ุฃุฑุดูู" && toDept !== "ุฃุฑุดูู") actualTransactionType = "ุงุณุชูุงู";
                else if (fromDept !== "ุฃุฑุดูู" && toDept === "ุฃุฑุดูู") actualTransactionType = "ุชุณููู";

                // ูุนุงูุฌุฉ ุงูุนูุฏ ุงูุฎุงุต ุจูุชุงุจ ุงูุญุณู ูุชุญุฏูุฏ ูุนุฑููู (ุฅู ูุฌุฏ/ุฅูุดุงุก)
                let sdl_contract_id = null;
                if (operationCategory === 'ูุชุจ ุญุณู') {
                  // ุงูุชุญูู/ุงูุฅูุดุงุก ูุนูุฏ ูุงุญุฏ
                  let { data: existingContract } = await supabase
                    .from("contracts").select("id").eq("contract_number", sdlContractNumber).maybeSingle();

                  if (!existingContract) {
                    const { data: newContract, error: cErr } = await supabase
                      .from("contracts")
                      .insert({
                        contract_number: sdlContractNumber,
                        current_holder_id: toEmp.id,
                        status: "ูุน " + toEmployee,
                      })
                      .select()
                      .single();
                    if (cErr) throw cErr;
                    existingContract = newContract;
                  }
                  sdl_contract_id = existingContract.id;
                }

                // ุฅุฏุฎุงู ุงูุญุฑูุฉ
                const { data: transaction, error: transError } = await supabase
                  .from("transactions")
                  .insert({
                    transaction_type: actualTransactionType,
                    from_employee_id: fromEmp.id,
                    to_employee_id: toEmp.id,
                    receipt_number: receiptNumber,
                    notes: notes,

                    // ุงูุญููู ุงูุฌุฏูุฏุฉ
                    operation_category: operationCategory,
                    delivery_method: deliveryMethod,
                    tracking_number: trackingNumber,
                    shipment_status: (shippingMethods.includes(deliveryMethod) ? 'ููุฏ ุงูุดุญู' : null),
                    contents: contents,

                    // ุญููู ูุชุงุจ ุงูุญุณู
                    sdl_customer_name: (operationCategory === 'ูุชุจ ุญุณู') ? sdlCustomerName : null,
                    sdl_contract_id:   (operationCategory === 'ูุชุจ ุญุณู') ? sdl_contract_id : null,
                    sdl_judiciary_number: (operationCategory === 'ูุชุจ ุญุณู') ? sdlJudiciaryNumber : null,
                    sdl_judiciary_year:   (operationCategory === 'ูุชุจ ุญุณู') ? Number(sdlJudiciaryYear) : null
                  })
                  .select()
                  .single();

                if (transError) throw transError;

                // ูุนุงูุฌุฉ ุงูุนููุฏ (ูุชุนุฏุฏุฉ ุฅูุง ูู ูุชุงุจ ุงูุญุณู ุณุชููู ูุงุญุฏุฉ)
                for (let contractNum of contractNumbers) {
                  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุฏ ุฃู ุฅูุดุงุคู
                  let { data: contract } = await supabase.from("contracts").select("id").eq("contract_number", contractNum.trim()).maybeSingle();
                  if (!contract) {
                    const { data: newContract, error: contractError } = await supabase
                      .from("contracts")
                      .insert({
                        contract_number: contractNum.trim(),
                        current_holder_id: toEmp.id,
                        status: "ูุน " + toEmployee,
                      })
                      .select()
                      .single();
                    if (contractError) throw contractError;
                    contract = newContract;
                  }

                  // ุฑุจุท ุชูุงุตูู ุงูุญุฑูุฉ
                  const { error: detailError } = await supabase
                    .from("transaction_details")
                    .insert({ transaction_id: transaction.id, contract_id: contract.id });
                  if (detailError) throw detailError;
                }

                showLoading(false);
                showAlert("ุชู ุญูุธ ุงูุญุฑูุฉ ุจูุฌุงุญ!", "success");

                // ุนุฑุถ ุงูุฅูุตุงู
                showReceipt({
                  receiptNumber,
                  transactionType: actualTransactionType,
                  date: new Date(),
                  fromEmployee: fromEmployee,
                  toEmployee: toEmployee,
                  contractNumbers: contractNumbers,
                  notes: notes,
                  operationCategory,
                  deliveryMethod,
                  trackingNumber,
                  contents,
                  sdl: (operationCategory === 'ูุชุจ ุญุณู') ? {
                    customerName: sdlCustomerName,
                    contractNumber: sdlContractNumber,
                    judiciaryNumber: sdlJudiciaryNumber,
                    judiciaryYear: sdlJudiciaryYear
                  } : null
                });

                // ุชูุธูู ุงูุญููู
                document.getElementById("contractNumbers").value = "";
                document.getElementById("notes").value = "";
                document.getElementById("trackingNumber").value = "";
                document.getElementById("contents").value = "";
                if (operationCategory === 'ูุชุจ ุญุณู') {
                  document.getElementById("sdlCustomerName").value = "";
                  document.getElementById("sdlContractNumber").value = "";
                  document.getElementById("sdlJudiciaryNumber").value = "";
                  document.getElementById("sdlJudiciaryYear").value = "";
                }
              } catch (error) {
                showLoading(false);
                showAlert("ุญุฏุซ ุฎุทุฃ: " + error.message, "error");
                console.error("ุฎุทุฃ:", error);
              }
            }


              showLoading(true);

              try {
                // ุงูุญุตูู ุนูู ูุนุฑูุงุช ุงูููุธููู
                const { data: fromEmp } = await supabase
                  .from("employees")
                  .select("id")
                  .eq("name", fromEmployee)
                  .single();

                const { data: toEmp } = await supabase
                  .from("employees")
                  .select("id")
                  .eq("name", toEmployee)
                  .single();

                // ุฅูุดุงุก ุฑูู ุงูุฅูุตุงู
                const receiptNumber = "RCP-" + Date.now();

                // ุชุญุฏูุฏ ููุน ุงูุญุฑูุฉ ุจูุงุกู ุนูู ุงูุฃูุณุงู
                let actualTransactionType = "ุชุณููู ูุงุณุชูุงู";
                const fromDept = getEmployeeDepartment(fromEmployee);
                const toDept = getEmployeeDepartment(toEmployee);

                if (fromDept === "ุฃุฑุดูู" && toDept !== "ุฃุฑุดูู") {
                  actualTransactionType = "ุงุณุชูุงู";
                } else if (fromDept !== "ุฃุฑุดูู" && toDept === "ุฃุฑุดูู") {
                  actualTransactionType = "ุชุณููู";
                }

                // ุฅุฏุฎุงู ุงูุญุฑูุฉ
                const { data: transaction, error: transError } = await supabase
                  .from("transactions")
                  .insert({
                    transaction_type: actualTransactionType,
                    from_employee_id: fromEmp.id,
                    to_employee_id: toEmp.id,
                    receipt_number: receiptNumber,
                    notes: notes,
                  })
                  .select()
                  .single();

                if (transError) throw transError;

                // ูุนุงูุฌุฉ ุงูุนููุฏ
                for (let contractNum of contractNumbers) {
                  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุฏ ุฃู ุฅูุดุงุคู
                  let { data: contract } = await supabase
                    .from("contracts")
                    .select("id")
                    .eq("contract_number", contractNum.trim())
                    .single();

                  if (!contract) {
                    // ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ
                    const { data: newContract, error: contractError } = await supabase
                      .from("contracts")
                      .insert({
                        contract_number: contractNum.trim(),
                        current_holder_id: toEmp.id,
                        status: "ูุน " + toEmployee,
                      })
                      .select()
                      .single();

                    if (contractError) throw contractError;
                    contract = newContract;
                  } else {
                    // ุชุญุฏูุซ ุญุงูู ุงูุนูุฏ ุงูุญุงูู
                    const { error: updateError } = await supabase
                      .from("contracts")
                      .update({
                        current_holder_id: toEmp.id,
                        status: "ูุน " + toEmployee,
                        updated_at: new Date().toISOString(),
                      })
                      .eq("id", contract.id);

                    if (updateError) throw updateError;
                  }

                  // ุฅุถุงูุฉ ุชูุงุตูู ุงูุญุฑูุฉ
                  const { error: detailError } = await supabase
                    .from("transaction_details")
                    .insert({
                      transaction_id: transaction.id,
                      contract_id: contract.id,
                    });

                  if (detailError) throw detailError;
                }

                showLoading(false);
                showAlert("ุชู ุญูุธ ุงูุญุฑูุฉ ุจูุฌุงุญ!", "success");

                // ุนุฑุถ ุงูุฅูุตุงู
                showReceipt({
                  receiptNumber,
                  transactionType: actualTransactionType,
                  fromEmployee,
                  toEmployee,
                  contractNumbers,
                  notes,
                  date: new Date().toLocaleString("ar-SA"),
                });

                // ูุณุญ ุงููููุฐุฌ
                clearForm();

                // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
                loadStatistics();
              } catch (error) {
                showLoading(false);
                showAlert("ุญุฏุซ ุฎุทุฃ: " + error.message, "error");
                console.error("ุฎุทุฃ:", error);
              }
            }

            // ุงูุจุญุซ ุนู ุนูุฏ
            async function performSearch() {
              const searchTerm = document.getElementById("searchInput").value.trim();

              if (!searchTerm) {
                showAlert("ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูุนูุฏ", "error");
                return;
              }

              showLoading(true);

              try {
                // ุงูุจุญุซ ุนู ุงูุนูุฏ
                const { data: contract, error } = await supabase
                  .from("contracts")
                  .select(
                    `
                             *,
                             current_holder:employees!current_holder_id(name, department)
                         `
                  )
                  .eq("contract_number", searchTerm)
                  .single();

                if (error) {
                  if (error.code === "PGRST116") {
                    showSearchResults([]);
                    showAlert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุฏ", "error");
                  } else {
                    throw error;
                  }
                } else {
                  // ุงูุญุตูู ุนูู ุขุฎุฑ ุญุฑูุฉ ููุนูุฏ
                  const { data: lastTransaction } = await supabase
                    .from("transaction_details")
                    .select(
                      `
                                 transactions(
                                     transaction_type,
                                     transaction_date,
                                     from_employee:employees!from_employee_id(name),
                                     to_employee:employees!to_employee_id(name)
                                 )
                             `
                    )
                    .eq("contract_id", contract.id)
                    .order("created_at", { ascending: false })
                    .limit(1)
                    .single();

                  showSearchResults([
                    {
                      ...contract,
                      lastTransaction: lastTransaction?.transactions,
                    },
                  ]);
                }
              } catch (error) {
                showAlert("ุญุฏุซ ุฎุทุฃ ูู ุงูุจุญุซ: " + error.message, "error");
                console.error("ุฎุทุฃ:", error);
              } finally {
                showLoading(false);
              }
            }

            // ุงูุจุญุซ ุจุงูุถุบุท ุนูู Enter
            function searchContract(event) {
              if (event.key === "Enter") {
                performSearch();
              }
            }

            // ุนุฑุถ ูุชุงุฆุฌ ุงูุจุญุซ
            function showSearchResults(results) {
              const resultsDiv = document.getElementById("searchResults");

              if (results.length === 0) {
                resultsDiv.innerHTML = `
                         <div class="result-item">
                             <p style="text-align: center; color: #999;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>
                         </div>
                     `;
              } else {
                resultsDiv.innerHTML = results
                  .map(
                    (contract) => `
                         <div class="result-item">
                             <h3>๐ ุนูุฏ ุฑูู: ${contract.contract_number}</h3>
                             <p><strong>ุงูุญุงูุฉ:</strong> ${
                               contract.status || "ุบูุฑ ูุญุฏุฏ"
                             }</p>
                             <p><strong>ุงูููุธู ุงูุญุงูู:</strong> ${
                               contract.current_holder?.name || "ุบูุฑ ูุญุฏุฏ"
                             }</p>
                             <p><strong>ุงููุณู:</strong> ${
                               contract.current_holder?.department || "ุบูุฑ ูุญุฏุฏ"
                             }</p>
                             ${
                               contract.lastTransaction
                                 ? `
                                 <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
                                 <p><strong>ุขุฎุฑ ุญุฑูุฉ:</strong></p>
                                 <p>ุงูููุน: ${
                                   contract.lastTransaction.transaction_type
                                 }</p>
                                 <p>ุงูุชุงุฑูุฎ: ${new Date(
                                   contract.lastTransaction.transaction_date
                                 ).toLocaleString("ar-SA")}</p>
                                 <p>ูู: ${
                                   contract.lastTransaction.from_employee?.name
                                 }</p>
                                 <p>ุฅูู: ${
                                   contract.lastTransaction.to_employee?.name
                                 }</p>
                             `
                                 : ""
                             }
                             <span class="status-badge ${
                               contract.current_holder?.department === "ููุชุจ"
                                 ? "status-busy"
                                 : "status-available"
                             }">
                                 ${
                                   contract.current_holder?.department === "ููุชุจ"
                                     ? "๐ ูู ุงูููุชุจ"
                                     : "๐ฆ ูู ุงูุฃุฑุดูู"
                                 }
                             </span>
                         </div>
                     `
                  )
                  .join("");
              }

              resultsDiv.style.display = "block";
            }

            // ุนุฑุถ ุฌููุน ุงูุนููุฏ
            async function showAllContracts() {
              showLoading(true);

              try {
                const { data: contracts, error } = await supabase
                  .from("contracts")
                  .select(
                    `
                             *,
                             current_holder:employees!current_holder_id(name, department)
                         `
                  )
                  .order("contract_number");

                if (error) throw error;

                const contractsDiv = document.getElementById("allContracts");

                if (contracts.length === 0) {
                  contractsDiv.innerHTML =
                    '<p style="text-align: center;">ูุง ุชูุฌุฏ ุนููุฏ ูุณุฌูุฉ</p>';
                } else {
                  contractsDiv.innerHTML = `
                             <table>
                                 <thead>
                                     <tr>
                                         <th>ุฑูู ุงูุนูุฏ</th>
                                         <th>ุงูุญุงูุฉ</th>
                                         <th>ุงูููุธู ุงูุญุงูู</th>
                                         <th>ุงููุณู</th>
                                         <th>ุชุงุฑูุฎ ุงูุชุญุฏูุซ</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     ${contracts
                                       .map(
                                         (contract) => `
                                         <tr>
                                             <td>${contract.contract_number}</td>
                                             <td>${contract.status || "ุบูุฑ ูุญุฏุฏ"}</td>
                                             <td>${
                                               contract.current_holder?.name ||
                                               "ุบูุฑ ูุญุฏุฏ"
                                             }</td>
                                             <td>
                                                 <span class="status-badge ${
                                                   contract.current_holder
                                                     ?.department === "ููุชุจ"
                                                     ? "status-busy"
                                                     : "status-available"
                                                 }">
                                                     ${
                                                       contract.current_holder
                                                         ?.department || "ุบูุฑ ูุญุฏุฏ"
                                                     }
                                                 </span>
                                             </td>
                                             <td>${new Date(
                                               contract.updated_at
                                             ).toLocaleDateString("ar-SA")}</td>
                                         </tr>
                                     `
                                       )
                                       .join("")}
                                 </tbody>
                             </table>
                         `;
                }

                contractsDiv.style.display = "block";
              } catch (error) {
                showAlert("ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุนููุฏ: " + error.message, "error");
                console.error("ุฎุทุฃ:", error);
              } finally {
                showLoading(false);
              }
            }

            // ุชุญููู ุงูุฅุญุตุงุฆูุงุช
            async function loadStatistics() {
              try {
                // ุฅุฌูุงูู ุงูุนููุฏ
                const { count: totalContracts } = await supabase
                  .from("contracts")
                  .select("*", { count: "exact", head: true });

                // ุฅุฌูุงูู ุงูุญุฑูุงุช
                const { count: totalTransactions } = await supabase
                  .from("transactions")
                  .select("*", { count: "exact", head: true });

                // ุญุฑูุงุช ุงูููู
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const { count: todayTransactions } = await supabase
                  .from("transactions")
                  .select("*", { count: "exact", head: true })
                  .gte("transaction_date", today.toISOString());

                // ุชุญุฏูุซ ุงูุนุฑุถ
                document.getElementById("totalContracts").textContent =
                  totalContracts || 0;
                document.getElementById("totalTransactions").textContent =
                  totalTransactions || 0;
                document.getElementById("todayTransactions").textContent =
                  todayTransactions || 0;
              } catch (error) {
                console.error("ุฎุทุฃ ูู ุชุญููู ุงูุฅุญุตุงุฆูุงุช:", error);
              }
            }

            // ุชูููุฏ ุงูุชูุงุฑูุฑ
            async function generateReport() {
              const period = document.getElementById("reportPeriod").value;
              const reportContent = document.getElementById("reportContent");

              showLoading(true);

              try {
                let query = supabase
                  .from("transactions")
                  .select(
                    `
                             *,
                             from_employee:employees!from_employee_id(name, department),
                             to_employee:employees!to_employee_id(name, department),
                             transaction_details(count)
                         `
                  )
                  .order("transaction_date", { ascending: false });

                // ุชุทุจูู ููุชุฑ ุงููุชุฑุฉ ุงูุฒูููุฉ
                const now = new Date();
                let startDate;

                switch (period) {
                  case "today":
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                  case "week":
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                  case "month":
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                  default:
                    startDate = null;
                }

                if (startDate) {
                  query = query.gte("transaction_date", startDate.toISOString());
                }

                const { data: transactions, error } = await query;

                if (error) throw error;

                // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
                const stats = {
                  total: transactions.length,
                  ุงุณุชูุงู: transactions.filter((t) => t.transaction_type === "ุงุณุชูุงู")
                    .length,
                  ุชุณููู: transactions.filter((t) => t.transaction_type === "ุชุณููู")
                    .length,
                };

                reportContent.innerHTML = `
                         <div style="margin-bottom: 20px;">
                             <h3>๐ ููุฎุต ุงูุชูุฑูุฑ</h3>
                             <p>ุฅุฌูุงูู ุงูุญุฑูุงุช: <strong>${stats.total}</strong></p>
                             <p>ุนูููุงุช ุงูุงุณุชูุงู: <strong>${stats.ุงุณุชูุงู}</strong></p>
                             <p>ุนูููุงุช ุงูุชุณููู: <strong>${stats.ุชุณููู}</strong></p>
                         </div>

                         <table>
                             <thead>
                                 <tr>
                                     <th>ุฑูู ุงูุฅูุตุงู</th>
                                     <th>ุงูุชุงุฑูุฎ</th>
                                     <th>ุงูููุน</th>
                                     <th>ูู</th>
                                     <th>ุฅูู</th>
                                     <th>ุนุฏุฏ ุงูุนููุฏ</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${transactions
                                   .map(
                                     (t) => `
                                     <tr>
                                         <td>${t.receipt_number}</td>
                                         <td>${new Date(
                                           t.transaction_date
                                         ).toLocaleString("ar-SA")}</td>
                                         <td>
                                             <span class="status-badge ${
                                               t.transaction_type === "ุงุณุชูุงู"
                                                 ? "status-available"
                                                 : "status-busy"
                                             }">
                                                 ${t.transaction_type}
                                             </span>
                                         </td>
                                         <td>${t.from_employee?.name}</td>
                                         <td>${t.to_employee?.name}</td>
                                         <td>${
                                           t.transaction_details?.[0]?.count || 0
                                         }</td>
                                     </tr>
                                 `
                                   )
                                   .join("")}
                             </tbody>
                         </table>
                     `;
              } catch (error) {
                reportContent.innerHTML =
                  '<p style="color: red;">ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงูุชูุฑูุฑ</p>';
                console.error("ุฎุทุฃ:", error);
              } finally {
                showLoading(false);
              }
            }

            // ุชุญููู ุงูุณุฌู
            async function loadHistory() {
              const filter = document.getElementById("historyFilter")?.value || "all";
              const tbody = document.getElementById("historyTableBody");

              showLoading(true);

              try {
                let query = supabase
                  .from("transactions")
                  .select(
                    `
                             *,
                             from_employee:employees!from_employee_id(name),
                             to_employee:employees!to_employee_id(name),
                             transaction_details(
                                 contract:contracts(contract_number)
                             )
                         `
                  )
                  .order("transaction_date", { ascending: false });

                if (filter !== "all") {
                  query = query.eq("transaction_type", filter);
                }

                const { data: transactions, error } = await query;

                if (error) throw error;

                tbody.innerHTML = transactions
                  .map(
                    (t) => `
                         <tr>
                             <td>${t.receipt_number}</td>
                             <td>${new Date(t.transaction_date).toLocaleString(
                               "ar-SA"
                             )}</td>
                             <td>
                                 <span class="status-badge ${
                                   t.transaction_type === "ุงุณุชูุงู"
                                     ? "status-available"
                                     : "status-busy"
                                 }">
                                     ${t.transaction_type}
                                 </span>
                             </td>
                             <td>${t.from_employee?.name}</td>
                             <td>${t.to_employee?.name}</td>
                             <td>${t.transaction_details?.length || 0}</td>
                             <td>
                                 <button class="btn" style="padding: 5px 15px; font-size: 0.9em;"
                                         onclick="viewTransactionDetails('${t.id}')">
                                     ุนุฑุถ ุงูุชูุงุตูู
                                 </button>
                             </td>
                         </tr>
                     `
                  )
                  .join("");
              } catch (error) {
                tbody.innerHTML =
                  '<tr><td colspan="7" style="text-align: center; color: red;">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุณุฌู</td></tr>';
                console.error("ุฎุทุฃ:", error);
              } finally {
                showLoading(false);
              }
            }

            // ุนุฑุถ ุชูุงุตูู ุงูุญุฑูุฉ
            async function viewTransactionDetails(transactionId) {
              showLoading(true);

              try {
                const { data: transaction, error } = await supabase
                  .from("transactions")
                  .select(
                    `
                             *,
                             from_employee:employees!from_employee_id(name),
                             to_employee:employees!to_employee_id(name),
                             transaction_details(
                                 contract:contracts(contract_number)
                             )
                         `
                  )
                  .eq("id", transactionId)
                  .single();

                if (error) throw error;

                const contractNumbers = transaction.transaction_details.map(
                  (td) => td.contract.contract_number
                );

                showReceipt({
                  receiptNumber: transaction.receipt_number,
                  transactionType: transaction.transaction_type,
                  fromEmployee: transaction.from_employee.name,
                  toEmployee: transaction.to_employee.name,
                  contractNumbers: contractNumbers,
                  notes: transaction.notes,
                  date: new Date(transaction.transaction_date).toLocaleString(
                    "ar-SA"
                  ),
                });
              } catch (error) {
                showAlert("ุญุฏุซ ุฎุทุฃ ูู ุนุฑุถ ุงูุชูุงุตูู: " + error.message, "error");
                console.error("ุฎุทุฃ:", error);

              // ุฅุถุงูุฉ ูุณู ุชุฃููุฏ ุงูุงุณุชูุงู ุฅุฐุง ูุงูุช ุงูุดุญูุฉ ููุฏ ุงูุดุญู ุฃู ูู ุชุคูุฏ ุจุนุฏ
              (function(){
                const needsConfirm = (transaction.shipment_status === 'ููุฏ ุงูุดุญู') || (!transaction.received_confirmed && ['ุจุฑูุฏ ุฃุฑุฏูู','Aramex','DHL'].includes(transaction.delivery_method));
                if (needsConfirm) {
                  const confirmUI = `
                    <div style="margin-top:16px; padding:12px; background:#eef9f1; border:1px solid #b8e0c3; border-radius:8px;">
                      <h3 style="margin-bottom:10px;">ุชุฃููุฏ ุงูุงุณุชูุงู</h3>
                      <label style="display:block; margin:6px 0;">
                        <input type="checkbox" id="rc_contents_ok" /> ุงููุญุชููุงุช ูุทุงุจูุฉ
                      </label>
                      <div class="form-group">
                        <label>ุงูููุงูุต (ุฅู ูุฌุฏุช):</label>
                        <textarea id="rc_missing_notes" rows="2" placeholder="ุฃุฐูุฑ ุงูููุงูุต ุฅู ููุฌุฏุช"></textarea>
                      </div>
                      <div class="form-group">
                        <label>ููุงุญุธุงุช ุงููุณุชูู:</label>
                        <textarea id="rc_receiver_notes" rows="2" placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ"></textarea>
                      </div>
                      <button class="btn" onclick="confirmReceipt('${transaction.id}')">โ๏ธ ุชุฃููุฏ ุงูุงุณุชูุงู</button>
                    </div>
                  `;
                  document.getElementById('receiptContent').insertAdjacentHTML('beforeend', confirmUI);
                }
              })();


            // ุนุฑุถ ุงูุฅูุตุงู
            function showReceipt(data) {
              const receiptContent = document.getElementById("receiptContent");

              receiptContent.innerHTML = `
                     <div class="receipt">
                         <div class="receipt-header">
                             <h2>ุฅูุตุงู ${data.transactionType}</h2>
                             <p>ุฑูู ุงูุฅูุตุงู: <strong>${
                               data.receiptNumber
                             }</strong></p>
                             <p>ุงูุชุงุฑูุฎ: ${data.date}</p>
                         </div>

                         <div class="receipt-info">
                             <p><strong>ููุน ุงูุนูููุฉ:</strong> ${
                               data.transactionType
                             }</p>
                             <p><strong>ุงูููุธู ุงูููุณูููู:</strong> ${
                               data.fromEmployee
                             }</p>
                             <p><strong>ุงูููุธู ุงูููุณุชููู:</strong> ${
                               data.toEmployee
                             }</p>

                             <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <p><strong>ุงูุนููุฏ ุงูููุณุชููุฉ/ุงูููุณูููุฉ:</strong></p>
                                 <ol style="margin-top: 10px; padding-right: 20px;">
                                     ${data.contractNumbers
                                       .map((num) => `<li>${num}</li>`)
                                       .join("")}
                                 </ol>
                                 <p style="margin-top: 15px;"><strong>ุงูุนุฏุฏ ุงูุฅุฌูุงูู:</strong> ${
                                   data.contractNumbers.length
                                 } ุนูุฏ</p>
                             </div>

                             ${
                               data.notes
                                 ? `
                                 <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px;">
                                     <p><strong>ููุงุญุธุงุช:</strong></p>
                                     <p>${data.notes}</p>
                                 </div>
                             `
                                 : ""
                             }
                         </div>

                         <div class="signature-section">
                             <div class="signature-box">
                                 <div class="signature-line"></div>
                                 <p><strong>ุชูููุน ุงูููุณูููู</strong></p>
                                 <p>${data.fromEmployee}</p>
                             </div>
                             <div class="signature-box">
                                 <div class="signature-line"></div>
                                 <p><strong>ุชูููุน ุงูููุณุชููู</strong></p>
                                 <p>${data.toEmployee}</p>
                             </div>
                         </div>
                     </div>
                 `;

              document.getElementById("receiptModal").classList.add("active");
            }

            // ุทุจุงุนุฉ ุงูุฅูุตุงู
            function printReceipt() {
              window.print();
            }

            // ุฅุบูุงู ุงููุงูุฐุฉ ุงูููุจุซูุฉ
            function closeModal() {
              document.getElementById("receiptModal").classList.remove("active");
            }

            // ูุณุญ ุงููููุฐุฌ
            function clearForm() {
              document.getElementById("transactionType").value = "";
              document.getElementById("fromEmployee").innerHTML =
                '<option value="">-- ุงุฎุชุฑ ุงูููุธู --</option>';
              document.getElementById("toEmployee").innerHTML =
                '<option value="">-- ุงุฎุชุฑ ุงูููุธู --</option>';
              document.getElementById("contractNumbers").value = "";
              document.getElementById("notes").value = "";
            }

            // ุนุฑุถ/ุฅุฎูุงุก ูุคุดุฑ ุงูุชุญููู
            function showLoading(show) {
              const loading = document.getElementById("loading");
              if (show) {
                loading.classList.add("active");
              } else {
                loading.classList.remove("active");
              }
            }

            // ุนุฑุถ ุงูุฅุดุนุงุฑุงุช
            function showAlert(message, type) {
              const alert = document.getElementById("alert");
              alert.textContent = message;
              alert.className = `alert alert-${type} active`;

              setTimeout(() => {
                alert.classList.remove("active");
              }, 5000);
            }

            // ุฅุบูุงู ุงููุงูุฐุฉ ุงูููุจุซูุฉ ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌูุง
            window.onclick = function (event) {
              const modal = document.getElementById("receiptModal");
              if (event.target === modal) {
                closeModal();
              }
            };
    </script>

    <!-- Injected by helper: enforce date format DD/MM/YYYY - hh:mm AM/PM for ar-SA -->
    <script>
      (function () {
        // Keep originals
        var _toLocaleString = Date.prototype.toLocaleString;
        var _toLocaleDateString = Date.prototype.toLocaleDateString;

        function pad2(n) {
          return String(n).padStart(2, "0");
        }
        function fmt(d) {
          try {
            var day = pad2(d.getDate());
            var mon = pad2(d.getMonth() + 1);
            var yr = d.getFullYear();
            var h = d.getHours();
            var m = pad2(d.getMinutes());
            var ampm = h >= 12 ? "PM" : "AM";
            h = h % 12;
            h = h ? h : 12;
            h = pad2(h);
            return (
              day + "/" + mon + "/" + yr + " - " + h + ":" + m + " " + ampm
            );
          } catch (e) {
            return "-";
          }
        }

        Date.prototype.toLocaleString = function (locale, options) {
          if (locale === "ar-SA") {
            return fmt(this);
          }
          // Fallback to original behavior
          return _toLocaleString.apply(this, arguments);
        };

        Date.prototype.toLocaleDateString = function (locale, options) {
          if (locale === "ar-SA") {
            return fmt(this);
          }
          return _toLocaleDateString.apply(this, arguments);
        };
      })();
    </script>
  </body>
</html>
