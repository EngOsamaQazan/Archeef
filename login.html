<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تسجيل الدخول - نظام الأرشيف</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="css/login.css" />
    <!-- تحميل مكتبة Supabase مرة واحدة فقط -->
    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="assets/js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
      // إضافة معالج أخطاء عام للنافذة للتعامل مع أخطاء CORS
      window.addEventListener("error", function (event) {
        if (event.message && event.message.includes("CORS")) {
          console.error("تم اكتشاف خطأ CORS:", event.message);
          // إذا كانت الوظيفة متاحة، قم بتحديث حالة الاتصال
          if (typeof window.updateConnectionStatus === "function") {
            window.updateConnectionStatus("cors_error");
          }
        }
      });

      // التحقق من وجود مكتبة Supabase
      if (typeof supabase === "undefined") {
        console.error("خطأ: مكتبة Supabase غير متوفرة");
      } else {
        console.log("تم تحميل مكتبة Supabase بنجاح");
      }
    </script>
  </head>
  <body>
    <div class="container">
      <div class="login-container">
        <div class="login-header">
          <img
            src="assets/logo.svg"
            alt="شعار نظام الأرشيف"
            class="logo"
            id="logo"
          />
          <h1>نظام الأرشيف</h1>
          <p class="version">الإصدار <span id="app-version">1.0.0</span></p>
        </div>

        <div class="login-form">
          <div
            class="alert alert-danger d-none"
            id="error-message"
            role="alert"
          >
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span id="error-text"></span>
          </div>

          <div
            class="alert alert-success d-none"
            id="success-message"
            role="alert"
          >
            <i class="bi bi-check-circle-fill"></i>
            <span id="success-text"></span>
          </div>

          <div class="login-tabs">
            <button class="tab-btn active" id="login-tab">تسجيل الدخول</button>
            <button class="tab-btn" id="magic-link-tab">رابط سحري</button>
          </div>

          <div class="tab-content" id="login-tab-content">
            <div class="alert alert-info" role="alert">
              <i class="bi bi-info-circle"></i>
              <strong>نصيحة:</strong> إذا لم تكن متأكداً من حالة حسابك، استخدم
              زر <i class="bi bi-question-circle"></i> بجانب حقل البريد
              الإلكتروني للتحقق من حالة الحساب.
            </div>
            <form id="login-form">
              <div class="mb-3">
                <label for="email" class="form-label">البريد الإلكتروني</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-envelope"></i
                  ></span>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    placeholder="أدخل بريدك الإلكتروني"
                    required
                  />
                  <button
                    class="btn btn-outline-info"
                    type="button"
                    id="check-account-btn"
                    title="التحقق من حالة الحساب"
                  >
                    <i class="bi bi-question-circle"></i>
                  </button>
                </div>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">كلمة المرور</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-lock"></i
                  ></span>
                  <input
                    type="password"
                    class="form-control"
                    id="password"
                    placeholder="أدخل كلمة المرور"
                    required
                  />
                  <button
                    class="btn btn-outline-secondary toggle-password"
                    type="button"
                  >
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="remember-me"
                />
                <label class="form-check-label" for="remember-me">تذكرني</label>
              </div>
              <button
                type="submit"
                class="btn btn-primary w-100"
                id="login-btn"
              >
                <span class="btn-text">تسجيل الدخول</span>
                <span
                  class="spinner-border spinner-border-sm d-none"
                  role="status"
                  aria-hidden="true"
                ></span>
              </button>
            </form>
            <div class="mt-3 text-center">
              <a href="#" id="forgot-password">نسيت كلمة المرور؟</a>
            </div>
          </div>

          <div class="tab-content d-none" id="magic-link-tab-content">
            <form id="magic-link-form">
              <div class="mb-3">
                <label for="magic-email" class="form-label"
                  >البريد الإلكتروني</label
                >
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-envelope"></i
                  ></span>
                  <input
                    type="email"
                    class="form-control"
                    id="magic-email"
                    placeholder="أدخل بريدك الإلكتروني"
                    required
                  />
                </div>
              </div>
              <button
                type="submit"
                class="btn btn-primary w-100"
                id="magic-link-btn"
              >
                <span class="btn-text">إرسال رابط تسجيل الدخول</span>
                <span
                  class="spinner-border spinner-border-sm d-none"
                  role="status"
                  aria-hidden="true"
                ></span>
              </button>
            </form>
            <div class="mt-3 text-center">
              <p class="magic-link-info">
                سيتم إرسال رابط لتسجيل الدخول إلى بريدك الإلكتروني. انقر على
                الرابط للدخول مباشرة دون الحاجة لكلمة مرور.
              </p>
            </div>
          </div>
        </div>

        <div class="connection-status">
          <div class="d-flex align-items-center">
            <span id="connection-indicator" class="indicator offline"></span>
            <span id="connection-text">جاري التحقق من الاتصال...</span>
          </div>
          <button
            class="btn btn-sm btn-outline-secondary"
            id="reset-connection-btn"
          >
            <i class="bi bi-arrow-repeat"></i>
            <span>إعادة الاتصال</span>
          </button>
        </div>

        <div class="login-footer">
          <p>
            © <span id="current-year">2023</span> نظام الأرشيف - جميع الحقوق
            محفوظة
          </p>
        </div>
      </div>
    </div>

    <!-- تضمين ملفات JavaScript -->
    <script src="js/login.js"></script>
  </body>
</html>
